#+TITLE: Emacs configuration file
#+AUTHOR: Bradley Strauss

#+STARTUP: showall

#+PROPERTY: header-args:emacs-lisp :tangle ~/.emacs
#+OPTIONS: toc:nil num:nil

#+HTML_HEAD_EXTRA: <style>pre {box-shadow: 0px 0px 0px #eee; background-color: #fafafa;}</style>

* Introduction

This [[http://www.orgmode.org][org-mode]] file is used to generate my =.emacs= configuration file.

A few quick reminders:
1. Tangle this file to =~/.emacs= with: =C-c C-v t=
2. This file assumes GNU Emacs 24 or higher.
3. To refresh local settings in a =#+PROPERTY= entry: place cursor on it and
   =C-c C-c=

** Header comments for tangled file

The output file should contain a warning not to edit the general file, since it
is compiled from org-babel:

#+BEGIN_SRC emacs-lisp
;; -----------------------------------------------------------------------------
;; Do not edit this file by hand! It is generated by the org-mode file:
;;
;; dot_emacs.org
;;
;; Make any changes to the .org file and re-tangle (M-x org-babel-tangle).
;; -----------------------------------------------------------------------------
#+END_SRC


* Package system
Emacs 24 introduced a packaging system for installing major modes and
applications. I'm starting to use this, but at the time of this comment
(2014-05-19) I don't have code to automatically load packages that aren't yet
installed. This is a *TODO* for portability.

We make sure we're loading packages by =package-initialize=.

#+BEGIN_SRC emacs-lisp
;; initialize the packaging system.  Note that package-initalize has
;; to come before we change any variable values.
(setq
 package-archives '(("gnu" . "http://elpa.gnu.org/packages/")
		    ("org" . "http://orgmode.org/elpa/")
                    ("melpa" . "http://melpa.org/packages/")
		    ("melpa-stable" . "http://stable.melpa.org/packages/")))

(package-initialize)
(when (not package-archive-contents)
  (package-refresh-contents)
  (package-install 'use-package))
(require 'use-package)

(use-package lsp-mode
  :init
  ;; set prefix for lsp-command-keymap (few alternatives - "C-l", "C-c l")
  (setq lsp-keymap-prefix "C-c l")
  :hook (;; replace XXX-mode with concrete major-mode(e. g. python-mode)
         (python-mode . lsp)
         ;; if you want which-key integration
         (lsp-mode . lsp-enable-which-key-integration))
  :commands lsp
  :ensure t
  :pin melpa)

(use-package lsp-ui
  :commands lsp-ui-mode
  :ensure t
  :pin melpa)

#+END_SRC


* Keybindings changes
#+BEGIN_SRC emacs-lisp
;; Keybindings changes ;;

;; Ctrl sequence to invoke Meta.
(global-set-key "\C-x\C-m" 'execute-extended-command)
(global-set-key "\C-c\C-m" 'execute-extended-command)
;; Ctrl sequence to backward kill word.
(global-set-key "\C-w" 'backward-kill-word)
(global-set-key "\C-x\C-k" 'kill-region)
(global-set-key "\C-c\C-k" 'kill-region)
;; remap command-p (super-p) for Mac
;; see: http://www.gnu.org/software/emacs/manual/html_node/elisp/Key-Binding-Commands.html
(global-unset-key (kbd "s-p"))

;; keybindings for window splitting
(global-set-key (kbd "<f8>") 'other-window)
(defun prev-window ()
  (interactive)
  (other-window -1))
(global-set-key (kbd "<f9>") 'prev-window)
(global-set-key (kbd "<f6>") 'delete-window)
#+END_SRC


* Environment changes
** Turn off the bell and menu bars
#+BEGIN_SRC emacs-lisp
;; Turn off bell noises
(setq ring-bell-function #'ignore)
;; Turn off the menu bar.
;; ;;(if (fboundp 'menu-bar-mode) (menu-bar-mode -1))
(if (fboundp 'tool-bar-mode) (tool-bar-mode -1))
(if (fboundp 'scroll-bar-mode) (scroll-bar-mode -1))

#+END_SRC

** Fonts
If we're on a GNU/Linux system, by default use the x11 font 7x14. Also
check if =window-system= is ='x= and we're running on Darwin, and set
a default font for this case.

Note: For OSX, the =window-sytem= is =ns= for NextStep.

#+BEGIN_SRC emacs-lisp
;; Default fonts
(let (my-system-font)
  (progn
    (when (eq system-type 'darwin )
      (if (eq window-system 'ns)
	  (setq my-system-font "Menlo 18"))
      (if (eq window-system 'x)
	  (setq my-system-font "7x14")))
    (when (eq system-type 'gnu/linux)
      (setq my-system-font "6x13"))
    (set-face-attribute 'default nil :font my-system-font)))

#+END_SRC

#+BEGIN_SRC emacs-lisp
;; ;; keep a list of recently opened files
;; (recentf-mode 1)

;; Higlight matching parentheses
(show-paren-mode t)
(setq show-paren-style 'expression)
;; ;; Enable automatic character pairing
;;(electric-pair-mode +1)
;; ;; Enable automatic indentation
;;(electric-indent-mode +1)


;; Display column number as well as line number in status bar
(column-number-mode t)
;; Display time, day, and date in status bar
(setq display-time-day-and-date t)
(display-time-mode t)

;; ;; ibuffer mode
(defalias 'list-buffers 'ibuffer)

;; make buffer switch command show suggestions
;; (ido-mode 1)

#+END_SRC
** Color themes
#+BEGIN_SRC emacs-lisp
;; ;; color themes
(add-to-list 'custom-theme-load-path "~/emacs/emacs-color-theme-solarized")
;; (load-theme 'solarized-light t)

#+END_SRC

** Undo tree
#+BEGIN_SRC emacs-lisp
;; undo-tree globally
;; default redo keys are C-? and M-_, undo are C-/ and C-_
;;(require 'undo-tree)
;;(global-undo-tree-mode t)
#+END_SRC


* Load paths
#+BEGIN_SRC emacs-lisp
;; (add-to-list 'load-path "~/emacs/ess-13.09-1/lisp")
;; (add-to-list 'load-path "~/elisp/ess-15.03-1/lisp")
;; Polymode stuff
;;(setq load-path
;;      (append '("~/emacs/polymode/" "~/emacs/polymode/modes")
;;	      load-path))
;;(add-to-list 'Info-additional-directory-list "~/emacs/info")

#+END_SRC


* Emacs+git
Emacs works pretty well with git, thanks to =git.el= and other related
utiltiles. These are included with the =git= distribution. The elisp
files are located at =/usr/local/share/git-core/contrib= under
Homebrew. See the =README= file there for details.

#+BEGIN_SRC emacs-lisp
  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
  ;; Emacs and git integration ;;
  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

  ;; (if (eq system-type 'darwin)
  ;;     (add-to-list 'load-path "/usr/local/share/git-core/contrib/emacs"))
  ;; (if (eq system-type 'gnu/linux)
  ;;     (add-to-list 'load-path "/usr/share/doc/git-core/contrib/emacs"))
  ;; (require 'git)
  ;; (require 'git-blame)

#+END_SRC


* Major modes
#+BEGIN_SRC emacs-lisp :exports none

;; ;;;;;;;;;;;;;;;;;;;;;;;;
;; ;; Emacs major modes  ;;
;; ;;;;;;;;;;;;;;;;;;;;;;;;

#+END_SRC

** Dired
Dired-x is an Emacs lisp library that includes some useful extra
commands. In particular, I use =dired-omit-files= a lot.
#+BEGIN_SRC emacs-lisp
;; Recent Emacsen don't need this method, we can just require directly.
;; (add-hook 'dired-load-hook '(lambda () (require 'dired-x)))
(require 'dired-x)
;; Ignore dot files
(setq dired-omit-files (concat dired-omit-files "\\|^\\..+$"))
#+END_SRC

** ESS
#+BEGIN_SRC emacs-lisp
;; ;; ESS for statistics
;; (require 'ess-site)
;; ;;(require 'ess-jags-d)
#+END_SRC

** Org-mode
*** General config (from old =.emacs)
#+BEGIN_SRC emacs-lisp
;;
;; Org mode Stuff
;;

;;(add-to-list 'auto-mode-alist '("\\.org\\'" . org-mode))
(add-to-list 'auto-mode-alist '("\\.org_archive\\'" . org-mode))

;;(require 'org-install)
;; various org mode convenience features
(setq org-insert-mode-line-in-empty-file t)
;; load agenda files
(setq org-agenda-files (quote ("~/Dropbox/org/swoop"
			       "~/Dropbox/org/tasks.org")))
;; I don't like the deadline warnings; if I can't see them in week
;; view, no need to worry about them.
(setq org-deadline-warning-days 0)
;; hide leading stars for cleaner look
;;(setq org-hide-leading-stars t)
;; no colors for headline text
(setq org-level-color-stars-only t)
;; turn on Org spped keys
(setq org-use-speed-commands t)

;; org-agenda views
(setq org-agenda-restore-windows-after-quit t)
;; The agenda should appear in a new frame
(setq org-agenda-window-setup (quote other-frame))

;; Org mode keybindings
(global-set-key "\C-ca" 'org-agenda)
(global-set-key "\C-cb" 'org-iswitchb)
;; (global-set-key "\C-cl" 'org-store-link)
#+END_SRC

*** Working with source code (org-babel)
Settings and customizations for working with source code.

#+BEGIN_SRC emacs-lisp
;; org-src settings
(setq org-src-fontify-natively t)
(setq org-src-tab-acts-natively t)
;; By default we ask for confirmation every time we evaluate a code
;; block.
(setq org-confirm-babel-evaluate nil)

;; Edit org-src code in the other window, rather than rearranging the
;; frames. I generally dislike rearragning frames and try to avoid it.
(setq org-src-window-setup 'other-window)

;; ;; org-babel languages
(org-babel-do-load-languages
 'org-babel-load-languages
 '((latex . t)
   (R . t)
   (ruby . t)
   (awk . t)
   (ditaa . t)
   (emacs-lisp . t)
   (makefile . t)))

;; (add-to-list 'org-src-lang-modes '("latex" . LaTeX))
(add-to-list 'org-src-lang-modes '("R" . R))
(add-to-list 'org-src-lang-modes '("js" . javascript))

;; Preserve leading whitespace characters in SRC blocks. Note: this is
;; important for making makefile tabs tangle correctly.
(setq org-src-preserve-indentation t)

;; org-tags-column sets the alignement for tags. Negative values
;; specify right alignment.
(setq org-tags-column -100)
(setq org-agenda-tags-column -120)

#+END_SRC

*** ditaa integration
This one's a little odd: for some reason the Org package on Elpa
doesn't have a working ditaa.jar file available. This messes up export
and compilation of ditaa snippets, which I use in work files.

The following sets a manually installed ditaa.jar in the appropriate
variable. This is a workaround that I should not need to do at some
point the future.

#+BEGIN_SRC emacs-lisp
(setq org-ditaa-jar-path "/Users/brad/emacs/org-8.2.6/contrib/scripts/ditaa.jar")
#+END_SRC

*** Task Management
This section defines global TODO keywords for all org files. Following the
advice of norang.ca, we generally avoid setting TODO keywords by  file, although
this is certainly possible. The idea is that if it's useful for one project it's
probably (or should be) useful for another. This also helps avoid costs
associated with context switching.

Note: Down the road, file-specific keywords may be useful for org-mode files set
up for exporting public HTML or LaTeX documents. norang.ca does this for his
=org-mode.html= file in order to hide TODO state keywords from exported
headlines.

**** =TODO= keywords for task management
This is a custom list of TODO states for managing tasks. This configuration is
based off of norang.ca.
#+BEGIN_SRC emacs-lisp
;; TODO state keywords configuration
(setq org-todo-keywords
      (quote ((sequence "TODO(t)" "NEXT(n)" "|" "DONE(d)")
	      (sequence "WAITING(w@/!)" "HOLD(h@/!)" "|" "CANCELLED(c@/!)"))))
#+END_SRC

**** =TODO= keyword faces
#+BEGIN_SRC emacs-lisp
(setq org-todo-keyword-faces
      (quote (
	      ("NEXT" :foreground "#268bd2" :weight bold))))
;;	      
#+END_SRC

**** Quickly change TODO states
#+BEGIN_SRC emacs-lisp
;; Enable logging timestamp when a task enters the DONE state
(setq org-log-done t)
;; Select states using shortcut keys from the fast todo selection
;; menu. This is extremely useful. Shortcut keys are defined in
;; org-todo-keywords.
(setq org-use-fast-todo-selection t)
;; Quickly cycle through todo states with S-left and S-right. This is
;; useful for changing the todo state keyword (for, e.g., a mistaken
;; entry) without changing the log entry.
(setq org-treat-S-cursor-todo-selection-as-state-change nil)
#+END_SRC

**** State keyword changing and tagging
#+BEGIN_SRC emacs-lisp
(setq org-todo-state-tags-triggers
      (quote (("CANCELLED" ("CANCELLED" . t))
              ("WAITING" ("WAITING" . t))
              ("HOLD" ("WAITING") ("HOLD" . t))
              (done ("WAITING") ("HOLD"))
              ("TODO" ("WAITING") ("CANCELLED") ("HOLD"))
              ("NEXT" ("WAITING") ("CANCELLED") ("HOLD"))
              ("DONE" ("WAITING") ("CANCELLED") ("HOLD")))))
;; enable Markdown export from org
(add-to-list 'org-export-backends 'md)

#+END_SRC

** AucTeX
On 2014-10-31 I had some trouble with the (at least I think) the
doc-view-mode-hook below. I was viewing R graphics plots as PDF files,
and saw some kind of problem with doc-view trying to update a deleted
buffer. The error messaging took over the status bar in Emacs, which
basically makes it unusable.

#+BEGIN_SRC emacs-lisp :export no
;; auctex
;; (load "~/emacs/site-lisp/auctex.el" nil t t)
;; (load "~/emacs/site-lisp/preview-latex.el" nil t t)
(load "auctex.el" nil t t)
(load "preview.el" nil t t)
(setq TeX-auto-save t)
(setq TeX-parse-self t)
;; I like the sub and superscript help...
(setq TeX-electric-sub-and-superscript t)
;; but I don't like the smaller fonts.
(setq font-latex-fontify-script nil)
;; Reload doc view files automatically when updated; very useful for
;; viewing changes in compiled LaTeX after recompiling.
(add-hook 'doc-view-mode-hook 'auto-revert-mode)
;; LaTeX files start in visual-line-mode by default
;;(add-hook 'LaTeX-mode-hook 'visual-line-mode)
;; Turn on reftex
(add-hook 'LaTeX-mode-hook 'turn-on-reftex)
;; Integrate reftex with AUCTeX
(setq reftex-plug-into-AUCTeX t)
;; As of Emacs 24.1, bibtex-parse-buffers-steathily throws annoying
;; bad argument errors. Not sure of the fix, so to work around it:
(setq bibtex-parse-keys-timeout 86400)
#+END_SRC

** Markdown mode
#+BEGIN_SRC emacs-lisp
;; Markdown mode
;; http://jblevins.org/projects/markdown-mode/
(autoload 'markdown-mode "markdown-mode"
  "Major mode for editing Markdown files" t)
(add-to-list 'auto-mode-alist '("\\.text\\'" . markdown-mode))
(add-to-list 'auto-mode-alist '("\\.markdown\\'" . markdown-mode))
(add-to-list 'auto-mode-alist '("\\.md\\'" . markdown-mode))
;; (add-to-list 'auto-mode-alist '("\\.Rmd\\'" . markdown-mode))
#+END_SRC

** Polymode
#+BEGIN_SRC emacs-lisp
;; Polymode
;; Edit a buffer using several major modes; particularly useful for Rmd files and knitr
;;(require 'poly-R)
;;(require 'poly-markdown)
;;(require 'poly-js)
#+END_SRC

** emacs-w3m
#+BEGIN_SRC emacs-lisp
;; ;; ;; emacs-w3m for web browsing
;; ;; (add-to-list 'load-path "/usr/local/share/emacs/site-lisp/w3m")
;; ;; (require 'w3m-load)
;; ;; ;; Use cookies so gmail works
;; ;; (setq w3m-use-cookies t)
#+END_SRC

** Tramp mode
** Ledger-mode
Loads ledger-mode for using ledger-cli files.

#+BEGIN_SRC emacs-lisp
;; (add-to-list 'load-path
;; 	     (expand-file-name "~/emacs/site-lisp/ledger/"))
;; (load "ledger-mode")
;; (add-to-list 'auto-mode-alist '("\\.ledger$" . ledger-mode))

#+END_SRC

*** Default settings
#+BEGIN_SRC emacs-lisp
;; ;; Tramp mode defaults
;; (require 'tramp)
;; (setq tramp-default-method "ssh")

#+END_SRC

** Doc-view
#+BEGIN_SRC emacs-lisp
(setq doc-view-continuous t)
#+END_SRC

** CEDET
#+BEGIN_SRC emacs-lisp
;; ;; CEDET
;; ;;(load-file "~/emacs/site-lisp/cedet-1.1/common/cedet.el")
;; ;; Enable EDE (project management) features
;; (global-ede-mode 1)
;; ;;(require 'semantic/sb)
;; (semantic-mode 1)
;; ;; Enable Semantic
;; ;;(semantic-load-enable-code-helpers)
;; (require 'semantic/analyze)
;; (provide 'semantic-analyze)
;; (provide 'semantic-ctxt)
;; (provide 'semanticdb)
;; (provide 'semanticdb-find)
;; (provide 'semanticdb-mode)
;; (provide 'semantic-load)
#+END_SRC

** ECB
#+BEGIN_SRC emacs-lisp
;; ;; ECB
;; (add-to-list 'load-path "~/emacs/site-lisp/ecb-2.40")
;; (require 'ecb)

#+END_SRC

** nXHTML
#+BEGIN_SRC emacs-lisp
;; ;; nXhtml mode
;; ;;(load "~/emacs/nxhtml/autostart.el")
#+END_SRC

** Javascript mode
#+BEGIN_SRC emacs-lisp
;; For compliance with Swoop coding standards
(setq js-indent-level 2)
#+END_SRC


* Run a shell
I generally don't do this anymore in the init, although I usually have
multiple shell buffers running.
#+BEGIN_SRC emacs-lisp
  ;; ;; Start a shell running.
  ;;(shell)
  ;; ;; rename the shell to *shell_local*
  ;;(rename-buffer "*shell_local*")
#+END_SRC

* Confirm quit with keyboard input
Usually there are unsaved buffers that will force you to answer a
prompt if you hit =C-x C-c= in an act of anger or lunacy, but better to
be safe.
#+BEGIN_SRC emacs-lisp
(setq confirm-kill-emacs (quote yes-or-no-p))
#+END_SRC

* Start the emacserver
Always do this last.
#+BEGIN_SRC emacs-lisp
;;(server-start)
#+END_SRC
  

* Old =.emacs= file content
#+BEGIN_SRC emacs-lisp
;; ;; (custom-set-variables
;; ;;  ;; custom-set-variables was added by Custom.
;; ;;  ;; If you edit it by hand, you could mess it up, so be careful.
;; ;;  ;; Your init file should contain only one such instance.
;; ;;  ;; If there is more than one, they won't work right.
;; ;;  '(ansi-color-names-vector ["#073642" "#dc322f" "#859900" "#b58900" "#268bd2" "#d33682" "#2aa198" "#657b83"])
;; ;;  '(background-color "#002b36")
;; ;;  '(background-mode dark)
;; ;;  '(confirm-kill-emacs (quote yes-or-no-p))
;; ;;  '(cursor-color "#839496")
;; ;;  '(custom-enabled-themes nil)
;; ;;  '(custom-safe-themes (quote ("1e7e097ec8cb1f8c3a912d7e1e0331caeed49fef6cff220be63bd2a6ba4cc365" "fc5fcb6f1f1c1bc01305694c59a1a861b008c534cae8d0e48e4d5e81ad718bc6" default)))
;; ;;  '(doc-view-continuous t)
;; ;;  '(foreground-color "#839496")
;; ;;  '(org-agenda-restore-windows-after-quit t)
;; ;;  '(org-agenda-window-setup (quote other-frame))
;; ;;  '(org-format-latex-options (quote (:foreground default :background default :scale 1.3 :html-foreground "Black" :html-background "Transparent" :html-scale 1.0 :matchers ("begin" "$1" "$" "$$" "\\(" "\\["))))
;; ;;  '(org-indirect-buffer-display (quote current-window))
;; ;;  '(org-link-frame-setup (quote ((vm . vm-visit-folder-other-frame) (gnus . org-gnus-no-new-news) (file . find-file-other-window) (wl . wl-other-frame))))
;; ;;  '(preview-scale-function (quote preview-scale-from-face))
;; ;;  '(type-break-good-rest-interval 300)
;; ;;  '(type-break-interval 3000)
;; ;;  '(type-break-keystroke-threshold (quote (2100 . 10500)))
;; ;;  '(type-break-mode-line-message-mode t))
;; ;; (custom-set-faces
;; ;;  ;; custom-set-faces was added by Custom.
;; ;;  ;; If you edit it by hand, you could mess it up, so be careful.
;; ;;  ;; Your init file should contain only one such instance.
;; ;;  ;; If there is more than one, they won't work right.
;; ;;  '(org-hide ((t (:foreground "gray")))))
;; (custom-set-variables
;;  ;; custom-set-variables was added by Custom.
;;  ;; If you edit it by hand, you could mess it up, so be careful.
;;  ;; Your init file should contain only one such instance.
;;  ;; If there is more than one, they won't work right.
;;  '(custom-safe-themes (quote ("fc5fcb6f1f1c1bc01305694c59a1a861b008c534cae8d0e48e4d5e81ad718bc6" "1e7e097ec8cb1f8c3a912d7e1e0331caeed49fef6cff220be63bd2a6ba4cc365" default))))
;; (custom-set-faces
;;  ;; custom-set-faces was added by Custom.
;;  ;; If you edit it by hand, you could mess it up, so be careful.
;;  ;; Your init file should contain only one such instance.
;;  ;; If there is more than one, they won't work right.
;;  )
#+END_SRC
